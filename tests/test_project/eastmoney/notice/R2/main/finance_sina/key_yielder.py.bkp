# coding: utf8
import arrow
from .. import scheduled
from finapi.eastmoney import EmListAPI


class OnlineKeyYielder(scheduled.KeyYielder):

    def __init__(self, config=None, logger=None):
        super(OnlineKeyYielder, self).__init__(config, logger)
        self.api = EmListAPI(logger=self.logger)

        now = arrow.now()
        days_to_today = self.config.get('days_to_today')
        if days_to_today:
            start = now.shift(days=-abs(days_to_today))
            self.start_date = start.format('YYYY-MM-DD')
            self.end_date = now.format('YYYY-MM-DD')
            self.logger.info('`start_date` null, Assume start_date: %s'\
                             % self.start_date)
        else:
            self.start_date = self.config.get('start_date', '1990-01-01')
            self.end_date = self.config.get('end_date')
            if self.end_date is None:
                self.end_date = now.format('YYYY-MM-DD')
                self.logger.info('`end_date` null, Assume end_date: %s' \
                                 % self.end_date)

        self.__all_keys = self.get_all_keys()
        self.__i = 0

    def get_all_keys(self):
        symbols = self._get_all_symbols()
        keys = [s + ':' + self.start_date + ':' + self.end_date for s in symbols]
        return keys

    def yield_key(self):
        rv = None
        if self.__i < len(self.__all_keys):
            rv = self.__all_keys[self.__i]
            self.__i += 1
        return rv

    def _get_all_symbols(self):
        # 包含A股和B股, 指数
        stocks = self.api.get_hs_stocks()
        s_symbols = ['S:' + i['market'] + i['code'] for i in stocks]
        # time.sleep(1)
        # indices = self.api.get_hs_indices()
        # i_symbols = ['I:' + i['market'] + i['code'] for i in indices]
        # return i_symbols + s_symbols
        return s_symbols
